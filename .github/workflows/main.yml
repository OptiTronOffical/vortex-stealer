name: Build Go Project with Garble

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true

    - name: Verify project structure
      run: |
        echo "Project contents:"
        dir
        echo "Main Go files:"
        dir *.go
        echo "Module info:"
        go mod download

    - name: Install Garble
      run: |
        go install mvdan.cc/garble@latest
        echo "$(go env GOPATH)/bin" >> $env:GITHUB_PATH

    - name: Build with Garble obfuscation
      run: |
        $env:GOOS = "windows"
        $env:GOARCH = "amd64"
        $env:GARBLE_WRITE = "true"
        
        garble -literals -tiny build `
          -ldflags="-H windowsgui -s -w" `
          -o "vortex_obfuscated.exe" `
          .

    - name: Verify build
      run: |
        if (Test-Path "vortex_obfuscated.exe") {
          echo "Build successful!"
          $file = Get-Item "vortex_obfuscated.exe"
          echo "File size: $([math]::Round($file.Length/1MB, 2)) MB"
        } else {
          echo "Build failed - no output file"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-obfuscated-exe
        path: vortex_obfuscated.exe
        retention-days: 1
